/*
 * Copyright (c) 2020 The ZMK Contributors
 *
 * SPDX-License-Identifier: MIT
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h> // Include for output control if needed

/ {
    behaviors {
        // Single Homerow Mod behavior for consistency
        hm: homerow_mods {
            compatible = "zmk,behavior-hold-tap";
            label = "HOMEROW_MODS";
            bindings = <&kp>, <&kp>; // Placeholder, actual mods defined in keymap

            #binding-cells = <2>;
            // Adjust timing as needed - start around 200-220ms
            tapping-term-ms = <200>;
            // Use tap-preferred for homerow mods
            flavor = "tap-preferred";
            // Optional: Helps prevent misfires on fast rolls. Adjust as needed (100-150ms)
            require-prior-idle-ms = <125>;
            // Optional: Set equal to tapping-term-ms if unsure
            quick-tap-ms = <200>;
        };

        // Layer Tap behavior for Thumb Keys
        lt: layer_tap {
            compatible = "zmk,behavior-hold-tap";
            label = "LAYER_TAP";
            bindings = <&kp>, <&mo>; // Tap key, Hold layer

            #binding-cells = <2>;
            // Generally make layer activation quick
            tapping-term-ms = <200>;
            // Hold-preferred is often better for layer keys
            flavor = "hold-preferred";
             // Optional: May not be needed for layer taps
            // require-prior-idle-ms = <100>;
        };

        // Optional Tap-Dance for Backspace / Ctrl+Backspace
        // Uncomment and assign in keymap (e.g., &td_bksp) if desired
        /*
        td_bksp: tap_dance_backspace {
            compatible = "zmk,behavior-tap-dance";
            label = "TD_BACKSPACE";
            #binding-cells = <0>;
            tapping-term-ms = <200>;
            bindings = <&kp BACKSPACE>, <&kp LC(BACKSPACE)>;
        };
        */
    };

    combos {
        compatible = "zmk,combos";

        // Keep useful combos
        caps {
            bindings = <&kp CAPS>;
            key-positions = <16 19>; // Z, C
            layers = <0>; // Only trigger on base layer
        };

        // JK Escape combo - common and useful
        jk_esc {
            bindings = <&kp ESCAPE>;
            key-positions = <31 32>; // J, K
            layers = <0>; // Only trigger on base layer
        };

        // Optional: Add combos for frequent symbols if desired
        // Example: Underscore combo
        /*
        under_combo {
            bindings = <&kp UNDER>;
            key-positions = <28 31>; // M, J
            layers = <0>;
        };
        */
        // Example: Dash combo
        /*
        dash_combo {
            bindings = <&kp MINUS>;
            key-positions = <4 7>; // R, G
            layers = <0>;
        };
        */
    };

    macros {
        // Keep useful macros
        save: save {
            compatible = "zmk,behavior-macro";
            label = "MACRO_SAVE";
            #binding-cells = <0>;
            // Ensure sequence is reliable (add pauses if needed)
            bindings = <&macro_tap &kp LCTL &kp S>; // Changed to standard Ctrl+S
            // Original Vim save: <&macro_tap>, <&kp ESCAPE &kp COLON &kp W &kp ENTER>;
        };

        email: email {
            compatible = "zmk,behavior-macro";
            label = "MACRO_EMAIL";
            #binding-cells = <0>;
            bindings = <&macro_tap &kp J &kp O &kp S &kp H &kp AT &kp J &kp O &kp S &kp H &kp B &kp L &kp A &kp I &kp S &kp DOT &kp C &kp O &kp M>;
        };
    };

    keymap {
        compatible = "zmk,keymap";

        // Base Layer (Layer 0)
        // Using mirrored Homerow Mods (GUI, ALT, CTL, SFT | SFT, CTL, ALT, GUI)
        // Simplified Thumb Cluster (ESC/L1 | SPACE/L2)
        home {
            label = "Base";
            bindings = <
// Left Hand                                                       // Right Hand
&kp TAB     &kp Q      &kp W      &kp E         &kp R         &kp T         &kp Y         &kp U        &kp I         &kp O         &kp P          &kp BACKSPACE
&kp LCTRL   &hm LGUI A &hm LALT S &hm LCTRL D   &hm LSHIFT F  &kp G         &kp H         &hm RSHIFT J &hm RCTRL K   &hm RALT L    &hm RGUI SEMI  &kp SQT       // LCTRL is often useful on the edge
&kp LSHIFT  &kp Z      &kp X      &kp C         &kp V         &kp B         &kp N         &kp M        &kp COMMA     &kp DOT       &kp SLASH      &kp RSHIFT    // Standard shifts on edges
                                  // Left Thumb                // Right Thumb
                                  &lt 1 ESC     &none         &none         &lt 2 SPACE   &none        &none // Tap: ESC, Hold: L1 | Tap: SPACE, Hold: L2
            >;
        };

        // Symbol Layer (Layer 1) - Activated by Left Thumb
        // Simple Key Presses - No Hold-Taps within the layer
        sym {
            label = "Symbols";
            bindings = <
// Left Hand                                                       // Right Hand
&trans      &kp EXCL   &kp AT     &kp HASH      &kp DLLR      &kp PRCNT     &kp CARET     &kp N7        &kp N8        &kp N9        &kp EQUAL      &kp DELETE
&trans      &kp GRAVE  &kp LBRC   &kp LCBR      &kp LPAREN    &kpUNDS       &kp PLUS      &kp N4        &kp N5        &kp N6        &kp MINUS      &kp TILDE
&trans      &kp PIPE   &kp RBRC   &kp RCBR      &kp RPAREN    &kp ASTRK     &kp BSLH      &kp N1        &kp N2        &kp N3        &kp COLON      &kp QUESTION
                                  // Left Thumb                // Right Thumb
                                  &trans        &none         &none         &kp N0        &none        &none // Keep layer active while holding
            >;
        };

        // Navigation & Function Layer (Layer 2) - Activated by Right Thumb
        // Simple Key Presses - No Hold-Taps within the layer
        nav {
            label = "Navigation";
            bindings = <
// Left Hand                                                       // Right Hand
&trans      &kp F1     &kp F2     &kp F3        &kp F4        &kp F5        &kp F6        &kp HOME      &kp PG_DN     &kp PG_UP     &kp END        &trans
&trans      &kp F7     &kp F8     &kp F9        &kp F10       &kp F11       &kp F12       &kp LEFT      &kp DOWN      &kp UP        &kp RIGHT      &trans
&trans      &kp PSCRN  &email     &save         &none         &none         &none         &kp LALT TAB  &kp LCTRL TAB &kp LGUI TAB  &none          &trans
                                  // Left Thumb                // Right Thumb
                                  &trans        &trans        &trans        &trans        &trans        &trans // All thumbs set to &trans for testing parser
            >;
        };

    };
};
